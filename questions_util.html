<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Manager Pro</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7fa; color: #333; }
        .filename-display { font-size: 12px; color: #6c757d; margin-top: 10px; word-break: break-all; }

        /* Header */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .unsaved-badge { background: #ffc107; color: #333; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .stats-pill { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 13px; }

        /* Layout */
        .container { display: grid; grid-template-columns: 280px 1fr; height: calc(100vh - 60px); }

        /* Sidebar */
        .sidebar { background: #fff; border-right: 1px solid #e0e0e0; overflow-y: auto; }
        .sidebar-section { padding: 20px; border-bottom: 1px solid #e0e0e0; }
        .sidebar-section h3 { font-size: 14px; color: #667eea; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .file-input-wrapper { position: relative; width: 100%; }
        .btn-load { width: 100%; padding: 12px; background: #667eea; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-load:hover { background: #5568d3; }
        input[type="file"] { display: none; }
        .category-tree { list-style: none; }
        .category-item { padding: 8px 12px; margin: 4px 0; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .category-item:hover { background: #f5f7fa; }
        .category-item:hover .category-actions { display: flex; }
        .category-item.active { background: #667eea; color: #fff; font-weight: 600; }
        .category-count { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .category-actions { display: none; gap: 4px; position: absolute; right: 50px; }
        .category-actions button { padding: 2px 6px; font-size: 11px; background: #667eea; color: #fff; border: none; border-radius: 3px; cursor: pointer; }
        .category-actions button:hover { background: #5568d3; }
        .btn-add { width: 100%; padding: 8px; background: transparent; border: 2px dashed #667eea; color: #667eea; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; margin-top: 10px; }
        .btn-add:hover { background: #f5f7fa; }
        .stats-summary { background: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 12px; }
        .stats-summary div { display: flex; justify-content: space-between; margin: 5px 0; }
        .stats-summary strong { color: #667eea; }

        /* Main Content */
        .main { padding: 30px; overflow-y: auto; }
        .welcome { text-align: center; padding: 100px 20px; color: #6c757d; }
        .welcome-icon { font-size: 80px; margin-bottom: 20px; }

        /* Action Bar */
        .action-bar { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .action-bar input { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; }
        .subcategory-header { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .subcategory-header h2 { color: #667eea; font-size: 20px; margin-bottom: 10px; }
        .subcategory-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-card-value { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-card-label { font-size: 12px; color: #6c757d; margin-top: 5px; }
        .quick-actions { display: flex; gap: 10px; margin-top: 15px; }

        /* Buttons */
        button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: #667eea; color: #fff; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-1px); }
        .btn-success { background: #28a745; color: #fff; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover { background: #545b62; }
        .btn-info { background: #17a2b8; color: #fff; }
        .btn-info:hover { background: #138496; }

        /* Question List */
        .questions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sort-controls { display: flex; gap: 10px; align-items: center; font-size: 13px; color: #6c757d; }
        .sort-controls select { padding: 5px 10px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px; }
        .questions-grid { display: grid; gap: 12px; }
        .question-card { background: #fff; padding: 20px; border-radius: 8px; border-left: 4px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; position: relative; }
        .question-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .question-card.new { border-left-color: #28a745; }
        .question-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .question-title { font-weight: 600; font-size: 15px; flex: 1; }
        .question-actions { display: flex; gap: 6px; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }
        .question-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 12px 0; }
        .option { padding: 8px 12px; background: #f5f7fa; border-radius: 4px; font-size: 13px; }
        .option.correct { background: #d4edda; color: #155724; font-weight: 600; border: 2px solid #28a745; }
        .question-meta { display: flex; gap: 12px; margin-top: 12px; font-size: 12px; color: #6c757d; flex-wrap: wrap; }
        .question-id { display: flex; align-items: center; gap: 5px; }
        .copy-id-btn { padding: 2px 6px; font-size: 11px; background: #e0e0e0; color: #333; border: none; border-radius: 3px; cursor: pointer; }
        .copy-id-btn:hover { background: #d0d0d0; }
        .badge { padding: 3px 8px; border-radius: 12px; font-weight: 600; color: #fff; font-size: 11px; }
        .badge-easy { background: #28a745; }
        .badge-medium { background: #ffc107; color: #333; }
        .badge-hard { background: #dc3545; }
        .badge-new { background: #17a2b8; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; border-radius: 8px; padding: 30px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #667eea; }
        .modal-header h2 { color: #667eea; font-size: 20px; }
        .close { font-size: 28px; cursor: pointer; color: #aaa; line-height: 1; }
        .close:hover { color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; color: #495057; }
        .form-group label .required { color: #dc3545; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px; }
        .form-group textarea { min-height: 150px; font-family: 'Courier New', monospace; resize: vertical; }
        .form-group input[type="color"] { height: 40px; }
        .form-group input[type="number"] { width: auto; min-width: 100px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .form-hint { font-size: 12px; color: #6c757d; margin-top: 5px; }

        /* Enhanced Reorganize Styles */
        .reorganize-category-item {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: move;
        }
        .reorganize-category-item:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }
        .reorganize-category-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .reorganize-category-item.drag-over {
            border-color: #22c55e;
            border-width: 2px;
            transform: scale(1.02);
        }
        .reorganize-category-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #f8f9fa, #fff);
            cursor: move;
            transition: background 0.2s;
        }
        .reorganize-category-header:hover {
            background: linear-gradient(to right, #e7f3ff, #f8f9fa);
        }
        .reorganize-category-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .category-drag-handle {
            font-size: 18px;
            color: #9ca3af;
            cursor: grab;
            margin-right: 8px;
            user-select: none;
        }
        .category-drag-handle:hover {
            color: #667eea;
        }
        .category-drag-handle:active {
            cursor: grabbing;
        }
        .category-icon {
            font-size: 24px;
            min-width: 30px;
            text-align: center;
        }
        .category-name-wrapper {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .category-main-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }
        .category-badges {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .level-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .level-badge::before {
            content: "🔒";
            font-size: 10px;
        }
        .category-stats-badge {
            background: #e5e7eb;
            color: #6b7280;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .expand-arrow {
            font-size: 12px;
            color: #6b7280;
            transition: transform 0.3s;
            margin-right: 10px;
        }
        .expand-arrow.expanded {
            transform: rotate(90deg);
        }
        .reorganize-category-actions {
            display: flex;
            gap: 8px;
        }
        .reorganize-category-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
        }
        .reorganize-category-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .reorganize-category-actions .btn-edit {
            border-color: #667eea;
            color: #667eea;
        }
        .reorganize-category-actions .btn-edit:hover {
            background: #667eea;
            color: white;
        }
        .reorganize-category-actions .btn-delete {
            border-color: #ef4444;
            color: #ef4444;
        }
        .reorganize-category-actions .btn-delete:hover {
            background: #ef4444;
            color: white;
        }
        .reorganize-category-actions .btn-up, .reorganize-category-actions .btn-down {
            border-color: #10b981;
            color: #10b981;
        }
        .reorganize-category-actions .btn-up:hover, .reorganize-category-actions .btn-down:hover {
            background: #10b981;
            color: white;
        }
        .reorganize-subcategories {
            padding: 0 15px 15px 15px;
            display: none;
            animation: slideDown 0.3s ease;
        }
        .reorganize-subcategories.expanded {
            display: block;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .reorganize-subcategory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            background: #f8f9fa;
            border-left: 3px solid #667eea;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: move;
        }
        .reorganize-subcategory-item:hover {
            background: #e7f3ff;
            transform: translateX(5px);
        }
        .reorganize-subcategory-item.dragging {
            opacity: 0.5;
            transform: translateX(10px) rotate(1deg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .reorganize-subcategory-item.drag-over {
            border-left-color: #22c55e;
            border-left-width: 5px;
            transform: scale(1.02);
        }
        .reorganize-subcategory-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .subcategory-drag-handle {
            font-size: 14px;
            color: #9ca3af;
            cursor: grab;
            margin-right: 5px;
            user-select: none;
        }
        .subcategory-drag-handle:hover {
            color: #667eea;
        }
        .subcategory-drag-handle:active {
            cursor: grabbing;
        }
        .subcategory-icon {
            font-size: 16px;
        }
        .subcategory-name {
            font-weight: 500;
            font-size: 14px;
        }
        .subcategory-count {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .subcategory-actions {
            display: flex;
            gap: 4px;
        }
        .subcategory-actions button {
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 3px;
            border: 1px solid #d1d5db;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
        }
        .subcategory-actions .btn-up, .subcategory-actions .btn-down {
            border-color: #10b981;
            color: #10b981;
        }
        .subcategory-actions .btn-up:hover, .subcategory-actions .btn-down:hover {
            background: #10b981;
            color: white;
        }
        .drop-zone {
            min-height: 4px;
            background: transparent;
            border-radius: 2px;
            transition: all 0.2s;
            margin: 2px 0;
        }
        .drop-zone.active {
            background: #22c55e;
            min-height: 8px;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
    </style>
</head>
<body>
<div class="header">
    <h1>🎯 Quiz Manager Pro</h1>
    <div class="header-actions">
        <div class="stats-pill" id="totalQuestionsHeader">0 questions</div>
        <div id="unsavedBadge" class="unsaved-badge" style="display: none;">● Unsaved Changes</div>
        <button id="downloadButton" class="btn-success" style="display: none;">💾 Download JSON</button>
    </div>
</div>

<div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-section">
            <div class="file-input-wrapper">
                <button class="btn-load" onclick="document.getElementById('fileInput').click()">📁 Open questions.json</button>
                <input type="file" id="fileInput" accept=".json">
                <div id="filenameDisplay" class="filename-display"></div>
            </div>
        </div>

        <div class="sidebar-section">
            <h3>📂 Categories</h3>
            <button id="addCategoryButton" class="btn-add" style="display: none;" onclick="openAddCategoryModal()">+ Add Category</button>
            <button id="addSubcategoryButton" class="btn-add" style="display: none;">+ Add Subcategory</button>
            <button id="reorganizeButton" class="btn-secondary" style="display: none;">🔄 Reorganize</button>
            <ul id="categoryTree" class="category-tree"></ul>
        </div>

        <div class="sidebar-section" id="globalStats" style="display: none;">
            <h3>📊 Overview</h3>
            <div class="stats-summary">
                <div><span>Total Questions:</span> <strong id="globalTotal">0</strong></div>
                <div><span>Categories:</span> <strong id="globalCategories">0</strong></div>
                <div><span>Easy:</span> <strong id="globalEasy">0</strong></div>
                <div><span>Medium:</span> <strong id="globalMedium">0</strong></div>
                <div><span>Hard:</span> <strong id="globalHard">0</strong></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div id="welcomeScreen" class="welcome">
            <div class="welcome-icon">🚀</div>
            <h2>Welcome to Quiz Manager Pro</h2>
            <p style="margin-top: 10px; font-size: 15px;">Open your questions.json file to start</p>
            <p style="margin-top: 20px;">
                <button onclick="document.getElementById('fileInput').click()" class="btn-primary">Get Started</button>
            </p>
        </div>

        <div id="editorSection" style="display: none;">
            <!-- Subcategory Header -->
            <div class="subcategory-header" id="subcategoryHeader" style="display: none;">
                <h2 id="subcategoryTitle"></h2>
                <div class="subcategory-stats">
                    <div class="stat-card">
                        <div class="stat-card-value" id="subTotal">0</div>
                        <div class="stat-card-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="subEasy">0</div>
                        <div class="stat-card-label">Easy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="subMedium">0</div>
                        <div class="stat-card-label">Medium</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="subHard">0</div>
                        <div class="stat-card-label">Hard</div>
                    </div>
                </div>
                <div class="quick-actions">
                    <button id="exportSubButton" class="btn-info btn-sm">📤 Export</button>
                    <button id="editSubButton" class="btn-secondary btn-sm">✏️ Edit</button>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <input type="text" id="searchInput" placeholder="🔍 Search questions...">
                <select id="filterDifficulty">
                    <option value="">All Difficulties</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <select id="filterNew">
                    <option value="">All Questions</option>
                    <option value="new">New Only</option>
                </select>
                <button id="importJsonButton" class="btn-warning">📋 Import JSON</button>
                <button id="aiPromptButton" class="btn-primary">🤖 AI Prompt</button>
            </div>

            <!-- Questions Header with Sort -->
            <div class="questions-header">
                <div><strong id="questionCount">0 questions</strong></div>
                <div class="sort-controls">
                    <span>Sort by:</span>
                    <select id="sortBy">
                        <option value="default">Default Order</option>
                        <option value="id">ID (A-Z)</option>
                        <option value="difficulty">Difficulty</option>
                        <option value="newest">Newest First</option>
                    </select>
                </div>
            </div>

            <!-- Questions Grid -->
            <div id="questionsList" class="questions-grid"></div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>📋 Import Questions</h2>
            <span class="close" onclick="closeImportModal()">&times;</span>
        </div>

        <div class="form-group">
            <label>Paste JSON Array:</label>
            <textarea id="importTextarea" placeholder='[{"id":"q_001","question":"...","options":[...],"correct_answer":0,"explanation":"...","difficulty":"easy","points":10}]'></textarea>
            <div class="form-hint">Paste the JSON array from your AI assistant (ChatGPT, Claude, etc.)</div>
        </div>

        <div class="form-group">
            <label>Duplicate Handling:</label>
            <div class="duplicate-mode">
                <label><input type="radio" name="dupMode" value="skip" checked> 🚫 Skip</label>
                <label><input type="radio" name="dupMode" value="replace"> 🔄 Replace</label>
                <label><input type="radio" name="dupMode" value="rename"> ✏️ Rename</label>
            </div>
        </div>

        <div id="importPreview" style="display: none;"></div>
        <div id="duplicatePreview" style="display: none;"></div>

        <div class="form-actions">
            <button onclick="closeImportModal()" class="btn-secondary">Cancel</button>
            <button id="validateImportButton" class="btn-primary">🔍 Validate</button>
            <button id="confirmImportButton" class="btn-success" style="display: none;">✅ Import</button>
        </div>
    </div>
</div>

<!-- AI Prompt Modal -->
<div id="aiPromptModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>🤖 AI Prompt Generator</h2>
            <span class="close" onclick="closeAiPromptModal()">&times;</span>
        </div>

        <div class="form-group">
            <label>Copy this prompt for ChatGPT/Claude:</label>
            <textarea id="aiPromptText" readonly style="font-size: 13px; min-height: 300px;"></textarea>
        </div>

        <div class="form-actions">
            <button onclick="closeAiPromptModal()" class="btn-secondary">Close</button>
            <button id="copyPromptButton" class="btn-success">📋 Copy to Clipboard</button>
        </div>
    </div>
</div>

<!-- Add/Edit Category Modal -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="categoryModalTitle">➕ Add New Category</h2>
            <span class="close" onclick="closeCategoryModal()">&times;</span>
        </div>

        <div id="categoryForm">
            <div class="form-group">
                <label>Category ID <span class="required">*</span></label>
                <input type="text" id="catId" placeholder="e.g., math_advanced" required>
                <div class="form-hint">Use lowercase with underscores (no spaces)</div>
            </div>
            <div class="form-group">
                <label>Category Name <span class="required">*</span></label>
                <input type="text" id="catName" placeholder="e.g., Advanced Mathematics" required>
            </div>
            <div class="form-group">
                <label>Description <span class="required">*</span></label>
                <input type="text" id="catDesc" placeholder="Short description" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Icon</label>
                    <input type="text" id="catIcon" placeholder="e.g., 🔢" maxlength="2" value="📚">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="catColor" value="#667eea">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Timer (seconds) <span class="required">*</span></label>
                    <input type="number" id="catTimer" value="10" min="5" max="60" required>
                </div>
                <div class="form-group">
                    <label>Points per Question <span class="required">*</span></label>
                    <input type="number" id="catPoints" value="10" min="1" max="100" required>
                </div>
            </div>
            <div class="form-group">
                <label>Required Level</label>
                <input type="number" id="catRequiredLevel" value="1" min="1" max="100">
                <div class="form-hint">Minimum player level required to access this category</div>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="closeCategoryModal()" class="btn-secondary">Cancel</button>
            <button id="saveCategoryButton" class="btn-success">✅ Save Category</button>
        </div>
    </div>
</div>

<!-- Add Subcategory Modal -->
<div id="addSubcategoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>📁 Add Subcategory</h2>
            <span class="close" onclick="closeAddSubcategoryModal()">&times;</span>
        </div>

        <div id="addSubcategoryForm">
            <div class="form-group">
                <label>Parent Category <span class="required">*</span></label>
                <select id="parentCategorySelect" required>
                    <option value="">Select a category...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Subcategory ID <span class="required">*</span></label>
                <input type="text" id="newSubId" placeholder="e.g., calculus_basics" required>
                <div class="form-hint">Use lowercase with underscores (no spaces)</div>
            </div>
            <div class="form-group">
                <label>Subcategory Name <span class="required">*</span></label>
                <input type="text" id="newSubName" placeholder="e.g., Calculus Basics" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Icon</label>
                    <input type="text" id="newSubIcon" placeholder="e.g., 📐" maxlength="2" value="📝">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="newSubColor" value="#667eea">
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="closeAddSubcategoryModal()" class="btn-secondary">Cancel</button>
            <button id="saveNewSubcategoryButton" class="btn-success">✅ Add Subcategory</button>
        </div>
    </div>
</div>

<!-- Enhanced Reorganize Modal -->
<div id="reorganizeModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>🔄 Reorganize Categories</h2>
            <span class="close" onclick="closeReorganizeModal()">&times;</span>
        </div>

        <div class="reorganize-section">
            <h3 style="margin-bottom: 20px; color: #667eea;">📚 Category Management</h3>
            <div id="categoryList" class="category-list"></div>
        </div>

        <div class="form-actions">
            <button onclick="closeReorganizeModal()" class="btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Edit Subcategory Modal -->
<div id="subcategoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="subcategoryModalTitle">✏️ Edit Subcategory</h2>
            <span class="close" onclick="closeSubcategoryModal()">&times;</span>
        </div>

        <div id="subcategoryForm">
            <div class="form-group">
                <label>Subcategory ID <span class="required">*</span></label>
                <input type="text" id="subId" placeholder="e.g., calculus_basics" required>
                <div class="form-hint">Use lowercase with underscores (no spaces)</div>
            </div>
            <div class="form-group">
                <label>Subcategory Name <span class="required">*</span></label>
                <input type="text" id="subName" placeholder="e.g., Calculus Basics" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Icon</label>
                    <input type="text" id="subIcon" placeholder="e.g., 📐" maxlength="2" value="📝">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="subColor" value="#667eea">
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="closeSubcategoryModal()" class="btn-secondary">Cancel</button>
            <button id="saveSubcategoryButton" class="btn-success">✅ Save Changes</button>
        </div>
    </div>
</div>

<script>
    let mainData = null;
    let originalFilename = 'questions.json';
    let selectedCategory = null;
    let selectedSubcategory = null;
    let newQuestions = new Set();
    let hasChanges = false;
    let editingCategoryId = null;
    let editingSubcategoryId = null;

    // File input handler
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        originalFilename = file.name;
        const reader = new FileReader();

        reader.onload = (event) => {
            try {
                mainData = JSON.parse(event.target.result);

                if (!mainData.categories || !Array.isArray(mainData.categories)) {
                    throw new Error('Invalid JSON structure');
                }

                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('editorSection').style.display = 'block';
                document.getElementById('filenameDisplay').textContent = `Loaded: ${file.name}`;
                document.getElementById('addCategoryButton').style.display = 'block';
                document.getElementById('addSubcategoryButton').style.display = 'block';
                document.getElementById('reorganizeButton').style.display = 'block';
                document.getElementById('globalStats').style.display = 'block';

                populateCategories();
                updateGlobalStats();
                showStatus('✅ File loaded successfully!', 'success');
            } catch (err) {
                showStatus('❌ Error: ' + err.message, 'error');
            }
        };

        reader.readAsText(file);
    });

    function populateCategories() {
        const tree = document.getElementById('categoryTree');
        tree.innerHTML = '';

        mainData.categories.forEach(cat => {
            cat.subcategories?.forEach(sub => {
                const li = document.createElement('li');
                li.className = 'category-item';
                li.innerHTML = `
                    <span>${cat.name} › ${sub.name}</span>
                    <div class="category-actions">
                        <button onclick="editSubcategory('${cat.id}', '${sub.id}')">✏️</button>
                        <button onclick="deleteSubcategory('${cat.id}', '${sub.id}')">🗑️</button>
                    </div>
                    <span class="category-count">${sub.questions?.length || 0}</span>
                `;
                li.onclick = (e) => {
                    if (!e.target.closest('.category-actions')) {
                        selectSubcategory(cat.id, sub.id, li);
                    }
                };
                tree.appendChild(li);
            });
        });
    }

    function selectSubcategory(catId, subId, element) {
        document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        selectedCategory = catId;
        selectedSubcategory = subId;

        const category = mainData.categories.find(c => c.id === catId);
        const subcategory = category.subcategories.find(s => s.id === subId);

        document.getElementById('subcategoryHeader').style.display = 'block';
        document.getElementById('subcategoryTitle').textContent = `${category.name} › ${subcategory.name}`;

        updateSubcategoryStats();
        renderQuestions();
    }

    function updateSubcategoryStats() {
        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
        const questions = subcategory.questions || [];

        document.getElementById('subTotal').textContent = questions.length;
        document.getElementById('subEasy').textContent = questions.filter(q => q.difficulty === 'easy').length;
        document.getElementById('subMedium').textContent = questions.filter(q => q.difficulty === 'medium').length;
        document.getElementById('subHard').textContent = questions.filter(q => q.difficulty === 'hard').length;
    }

    function updateGlobalStats() {
        let total = 0, easy = 0, medium = 0, hard = 0;

        mainData.categories.forEach(cat => {
            cat.subcategories?.forEach(sub => {
                const questions = sub.questions || [];
                total += questions.length;
                easy += questions.filter(q => q.difficulty === 'easy').length;
                medium += questions.filter(q => q.difficulty === 'medium').length;
                hard += questions.filter(q => q.difficulty === 'hard').length;
            });
        });

        document.getElementById('globalTotal').textContent = total;
        document.getElementById('globalCategories').textContent = mainData.categories.length;
        document.getElementById('globalEasy').textContent = easy;
        document.getElementById('globalMedium').textContent = medium;
        document.getElementById('globalHard').textContent = hard;
        document.getElementById('totalQuestionsHeader').textContent = `${total} questions`;
    }

    function renderQuestions() {
        const list = document.getElementById('questionsList');
        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);

        if (!subcategory.questions) subcategory.questions = [];

        let questions = [...subcategory.questions];
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const diffFilter = document.getElementById('filterDifficulty').value;
        const newFilter = document.getElementById('filterNew').value;
        const sortBy = document.getElementById('sortBy').value;

        // Apply filters
        if (searchTerm) {
            questions = questions.filter(q =>
                q.question.toLowerCase().includes(searchTerm) || q.id.toLowerCase().includes(searchTerm)
            );
        }

        if (diffFilter) {
            questions = questions.filter(q => q.difficulty === diffFilter);
        }

        if (newFilter === 'new') {
            questions = questions.filter(q => newQuestions.has(q.id));
        }

        // Apply sorting
        if (sortBy === 'id') {
            questions.sort((a, b) => a.id.localeCompare(b.id));
        } else if (sortBy === 'difficulty') {
            const diffOrder = { easy: 1, medium: 2, hard: 3 };
            questions.sort((a, b) => diffOrder[a.difficulty] - diffOrder[b.difficulty]);
        } else if (sortBy === 'newest') {
            questions = questions.filter(q => newQuestions.has(q.id)).concat(
                questions.filter(q => !newQuestions.has(q.id))
            );
        }

        document.getElementById('questionCount').textContent = `${questions.length} question${questions.length !== 1 ? 's' : ''}`;

        if (questions.length === 0) {
            list.innerHTML = '<div class="empty-state" style="text-align: center; padding: 60px 20px; color: #6c757d;"><div class="empty-icon" style="font-size: 60px; margin-bottom: 15px; opacity: 0.5;">📭</div><p>No questions found. Click "Import JSON" to add.</p></div>';
            return;
        }

        list.innerHTML = questions.map(q => `
            <div class="question-card ${newQuestions.has(q.id) ? 'new' : ''}">
                <div class="question-header">
                    <div class="question-title">
                        ${escapeHtml(q.question)}
                        ${newQuestions.has(q.id) ? '<span class="badge badge-new">NEW</span>' : ''}
                    </div>
                    <div class="question-actions">
                        <button class="btn-danger btn-sm" onclick="deleteQuestion('${escapeHtml(q.id)}')">🗑️</button>
                    </div>
                </div>
                <div class="question-options">
                    ${q.options.map((opt, idx) => `
                        <div class="option ${idx === q.correct_answer ? 'correct' : ''}">${escapeHtml(opt)}</div>
                    `).join('')}
                </div>
                <div style="margin: 12px 0; font-size: 13px; color: #666;">
                    <strong>Explanation:</strong> ${escapeHtml(q.explanation)}
                </div>
                <div class="question-meta">
                    <span class="question-id">
                        <strong>ID:</strong> ${q.id}
                        <button class="copy-id-btn" onclick="copyToClipboard('${q.id}', event)">📋</button>
                    </span>
                    <span class="badge badge-${q.difficulty}">${q.difficulty.toUpperCase()}</span>
                    <span><strong>Points:</strong> ${q.points}</span>
                </div>
            </div>
        `).join('');
    }

    window.copyToClipboard = function(text, event) {
        event.stopPropagation();
        navigator.clipboard.writeText(text).then(() => {
            showStatus(`✅ Copied: ${text}`, 'success');
        });
    }

    window.deleteQuestion = function(id) {
        if (!confirm('Delete this question?')) return;

        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
        subcategory.questions = subcategory.questions.filter(q => q.id !== id);
        newQuestions.delete(id);

        markAsChanged();
        renderQuestions();
        updateSubcategoryStats();
        populateCategories();
        updateGlobalStats();
        showStatus('✅ Question deleted', 'success');
    }

    function markAsChanged() {
        hasChanges = true;
        document.getElementById('unsavedBadge').style.display = 'block';
        document.getElementById('downloadButton').style.display = 'block';
    }

    // Download button
    document.getElementById('downloadButton').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(mainData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = originalFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showStatus('💾 File downloaded! Replace your old file.', 'success');
        hasChanges = false;
        document.getElementById('unsavedBadge').style.display = 'none';
    });

    // Export subcategory
    document.getElementById('exportSubButton').addEventListener('click', () => {
        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);

        const blob = new Blob([JSON.stringify(subcategory.questions || [], null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${selectedSubcategory}_questions.json`;
        a.click();
        URL.revokeObjectURL(url);
        showStatus('✅ Subcategory exported!', 'success');
    });

    // Import Modal
    document.getElementById('importJsonButton').addEventListener('click', () => {
        if (!selectedCategory || !selectedSubcategory) {
            showStatus('❌ Select a subcategory first', 'error');
            return;
        }
        document.getElementById('importModal').classList.add('active');
        document.getElementById('importTextarea').value = '';
        document.getElementById('importPreview').style.display = 'none';
        document.getElementById('duplicatePreview').style.display = 'none';
        document.getElementById('confirmImportButton').style.display = 'none';
    });

    window.closeImportModal = function() {
        document.getElementById('importModal').classList.remove('active');
    }

    document.getElementById('validateImportButton').addEventListener('click', () => {
        try {
            const questions = JSON.parse(document.getElementById('importTextarea').value);

            if (!Array.isArray(questions)) throw new Error('Must be an array');
            if (questions.length === 0) throw new Error('Array is empty');

            // Validate each question
            const errors = [];
            questions.forEach((q, idx) => {
                if (!q.id) errors.push(`Q${idx + 1}: Missing ID`);
                if (!q.question) errors.push(`Q${idx + 1}: Missing question`);
                if (!Array.isArray(q.options) || q.options.length < 2) errors.push(`Q${idx + 1}: Need 2+ options`);
                if (typeof q.correct_answer !== 'number' || q.correct_answer < 0 || q.correct_answer >= q.options?.length) errors.push(`Q${idx + 1}: Invalid correct_answer`);
                if (!q.explanation) errors.push(`Q${idx + 1}: Missing explanation`);
                if (!['easy', 'medium', 'hard'].includes(q.difficulty)) errors.push(`Q${idx + 1}: Invalid difficulty (must be easy/medium/hard)`);
                if (typeof q.points !== 'number' || q.points <= 0) errors.push(`Q${idx + 1}: Invalid points`);
            });

            if (errors.length > 0) {
                throw new Error(errors.join('; '));
            }

            const category = mainData.categories.find(c => c.id === selectedCategory);
            const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
            const existingIds = new Set(subcategory.questions.map(q => q.id));
            const mode = document.querySelector('input[name="dupMode"]:checked').value;

            const duplicates = questions.filter(q => existingIds.has(q.id));
            const validQuestions = [];

            questions.forEach(q => {
                if (existingIds.has(q.id)) {
                    if (mode === 'replace') {
                        validQuestions.push(q);
                    } else if (mode === 'rename') {
                        let newId = q.id;
                        let v = 2;
                        while (existingIds.has(newId)) {
                            newId = `${q.id}_v${v++}`;
                        }
                        q.id = newId;
                        existingIds.add(newId);
                        validQuestions.push(q);
                    }
                } else {
                    validQuestions.push(q);
                    existingIds.add(q.id);
                }
            });

            // Show duplicate details
            if (duplicates.length > 0) {
                document.getElementById('duplicatePreview').innerHTML = `
                    <div class="duplicate-preview" style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 6px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">⚠️ ${duplicates.length} Duplicate ID(s) Found</h4>
                        <div class="duplicate-list" style="max-height: 200px; overflow-y: auto;">
                            ${duplicates.map(d => `<div class="duplicate-item" style="padding: 8px; background: #fff; margin: 5px 0; border-left: 3px solid #ffc107; border-radius: 3px; font-size: 13px;">
                                <strong>${d.id}</strong>: ${escapeHtml(d.question.substring(0, 80))}...
                            </div>`).join('')}
                        </div>
                        <p style="margin-top: 10px; font-size: 13px;">
                            <strong>Action:</strong> ${mode === 'skip' ? 'These will be SKIPPED' : mode === 'replace' ? 'These will REPLACE existing' : 'These will be RENAMED (_v2, _v3, etc.)'}
                        </p>
                    </div>
                `;
                document.getElementById('duplicatePreview').style.display = 'block';
            } else {
                document.getElementById('duplicatePreview').style.display = 'none';
            }

            const easyCount = validQuestions.filter(q => q.difficulty === 'easy').length;
            const mediumCount = validQuestions.filter(q => q.difficulty === 'medium').length;
            const hardCount = validQuestions.filter(q => q.difficulty === 'hard').length;

            document.getElementById('importPreview').innerHTML = `
                <div class="changes-preview" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">✅ Validation Successful</h4>
                    <p style="font-size: 14px; margin-bottom: 10px;">
                        <strong>${validQuestions.length} questions</strong> will be imported
                    </p>
                    <div class="import-details" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <div class="import-detail" style="background: #fff; padding: 10px; border-radius: 4px; text-align: center; border: 1px solid #e0e0e0;">
                            <div class="import-detail-value" style="font-size: 20px; font-weight: bold; color: #667eea;">${easyCount}</div>
                            <div class="import-detail-label" style="font-size: 11px; color: #6c757d; margin-top: 5px;">Easy</div>
                        </div>
                        <div class="import-detail" style="background: #fff; padding: 10px; border-radius: 4px; text-align: center; border: 1px solid #e0e0e0;">
                            <div class="import-detail-value" style="font-size: 20px; font-weight: bold; color: #667eea;">${mediumCount}</div>
                            <div class="import-detail-label" style="font-size: 11px; color: #6c757d; margin-top: 5px;">Medium</div>
                        </div>
                        <div class="import-detail" style="background: #fff; padding: 10px; border-radius: 4px; text-align: center; border: 1px solid #e0e0e0;">
                            <div class="import-detail-value" style="font-size: 20px; font-weight: bold; color: #667eea;">${hardCount}</div>
                            <div class="import-detail-label" style="font-size: 11px; color: #6c757d; margin-top: 5px;">Hard</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('importPreview').style.display = 'block';
            document.getElementById('confirmImportButton').style.display = 'block';

            window.validatedQuestions = { questions: validQuestions, mode };

        } catch (err) {
            showStatus('❌ ' + err.message, 'error');
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('duplicatePreview').style.display = 'none';
            document.getElementById('confirmImportButton').style.display = 'none';
        }
    });

    document.getElementById('confirmImportButton').addEventListener('click', () => {
        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
        const { questions, mode } = window.validatedQuestions;

        if (mode === 'replace') {
            const ids = new Set(questions.map(q => q.id));
            subcategory.questions = subcategory.questions.filter(q => !ids.has(q.id));
        }

        questions.forEach(q => newQuestions.add(q.id));
        subcategory.questions.push(...questions);

        markAsChanged();
        renderQuestions();
        updateSubcategoryStats();
        populateCategories();
        updateGlobalStats();
        closeImportModal();
        showStatus(`✅ Imported ${questions.length} questions!`, 'success');
    });

    // AI Prompt - 20 questions
    document.getElementById('aiPromptButton').addEventListener('click', () => {
        if (!selectedCategory || !selectedSubcategory) {
            showStatus('❌ Select a subcategory first', 'error');
            return;
        }

        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
        const nextNum = (subcategory.questions?.length || 0) + 1;
        const prefix = selectedSubcategory.split('_').pop();

        const prompt = `Generate 20 high-quality quiz questions for "${category.name} > ${subcategory.name}".

CRITICAL: Return ONLY a valid JSON array. No markdown code blocks, no explanations, no extra text.

[
  {
    "id": "${prefix}_${String(nextNum).padStart(3,'0')}",
    "question": "Your well-crafted question here?",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "correct_answer": 0,
    "explanation": "Clear, educational explanation of why this answer is correct.",
    "difficulty": "easy",
    "points": 10
  }
]

Requirements:
- Exactly 20 questions
- Difficulty mix: 8 easy, 8 medium, 4 hard
- All questions worth 10 points
- correct_answer is index (0-3)
- All 4 options should be plausible
- Explanations should be educational and clear
- Increment IDs: ${prefix}_${String(nextNum).padStart(3,'0')}, ${prefix}_${String(nextNum+1).padStart(3,'0')}, etc.

IMPORTANT: Return ONLY the JSON array. No code block markers, no text before or after.`;

        document.getElementById('aiPromptText').value = prompt;
        document.getElementById('aiPromptModal').classList.add('active');
    });

    window.closeAiPromptModal = function() {
        document.getElementById('aiPromptModal').classList.remove('active');
    }

    document.getElementById('copyPromptButton').addEventListener('click', () => {
        const text = document.getElementById('aiPromptText').value;
        navigator.clipboard.writeText(text).then(() => {
            showStatus('✅ Prompt copied! Paste into ChatGPT/Claude', 'success');
        });
    });

    // Category Management
    window.openAddCategoryModal = function() {
        document.getElementById('categoryModal').classList.add('active');
        document.getElementById('categoryModalTitle').textContent = '➕ Add New Category';
        editingCategoryId = null;

        // Clear form
        document.getElementById('catId').value = '';
        document.getElementById('catName').value = '';
        document.getElementById('catDesc').value = '';
        document.getElementById('catIcon').value = '📚';
        document.getElementById('catColor').value = '#667eea';
        document.getElementById('catTimer').value = '10';
        document.getElementById('catPoints').value = '10';
        document.getElementById('catRequiredLevel').value = '1';
    }

    window.closeCategoryModal = function() {
        document.getElementById('categoryModal').classList.remove('active');
    }

    document.getElementById('saveCategoryButton').addEventListener('click', () => {
        const id = document.getElementById('catId').value.trim();
        const name = document.getElementById('catName').value.trim();
        const desc = document.getElementById('catDesc').value.trim();
        const timer = parseInt(document.getElementById('catTimer').value);
        const points = parseInt(document.getElementById('catPoints').value);
        const requiredLevel = parseInt(document.getElementById('catRequiredLevel').value);

        if (!id || !name || !desc) {
            showStatus('❌ ID, Name, and Description are required', 'error');
            return;
        }

        if (!editingCategoryId && mainData.categories.some(c => c.id === id)) {
            showStatus('❌ Category ID already exists', 'error');
            return;
        }

        if (editingCategoryId) {
            const cat = mainData.categories.find(c => c.id === editingCategoryId);
            // Update category properties
            cat.id = id;
            cat.name = name;
            cat.description = desc;
            cat.icon = document.getElementById('catIcon').value;
            cat.color = document.getElementById('catColor').value;
            cat.question_timer_seconds = timer;
            cat.points_per_question = points;
            cat.requiredLevel = requiredLevel; // Fixed: use underscore
            showStatus('✅ Category updated!', 'success');
        } else {
            mainData.categories.push({
                id,
                name, // Fixed: removed duplicate
                description: desc,
                icon: document.getElementById('catIcon').value,
                color: document.getElementById('catColor').value,
                question_timer_seconds: timer,
                points_per_question: points,
                requiredLevel: requiredLevel, // Fixed: use underscore
                subcategories: []
            });
            showStatus('✅ Category created!', 'success');
        }

        markAsChanged();
        populateCategories();
        updateGlobalStats();
        closeCategoryModal();
    });

    // Subcategory Management
    window.closeSubcategoryModal = function() {
        document.getElementById('subcategoryModal').classList.remove('active');
    }

    window.editSubcategory = function(catId, subId) {
        const category = mainData.categories.find(c => c.id === catId);
        const subcategory = category.subcategories.find(s => s.id === subId);

        editingCategoryId = catId;
        editingSubcategoryId = subId;

        document.getElementById('subcategoryModal').classList.add('active');
        document.getElementById('subcategoryModalTitle').textContent = '✏️ Edit Subcategory';

        document.getElementById('subId').value = subcategory.id;
        document.getElementById('subName').value = subcategory.name;
        document.getElementById('subIcon').value = subcategory.icon || '📝';
        document.getElementById('subColor').value = subcategory.color || '#667eea';
    }

    document.getElementById('saveSubcategoryButton').addEventListener('click', () => {
        const id = document.getElementById('subId').value.trim();
        const name = document.getElementById('subName').value.trim();

        if (!id || !name) {
            showStatus('❌ ID and Name are required', 'error');
            return;
        }

        const category = mainData.categories.find(c => c.id === editingCategoryId);
        const subcategory = category.subcategories.find(s => s.id === editingSubcategoryId);

        subcategory.id = id;
        subcategory.name = name;
        subcategory.icon = document.getElementById('subIcon').value;
        subcategory.color = document.getElementById('subColor').value;

        if (selectedSubcategory === editingSubcategoryId) {
            selectedSubcategory = id;
            document.getElementById('subcategoryTitle').textContent = `${category.name} › ${name}`;
        }

        markAsChanged();
        populateCategories();
        closeSubcategoryModal();
        showStatus('✅ Subcategory updated!', 'success');
    });

    window.deleteSubcategory = function(catId, subId) {
        const category = mainData.categories.find(c => c.id === catId);
        const subcategory = category.subcategories.find(s => s.id === subId);

        if (!confirm(`Delete "${subcategory.name}" with ${subcategory.questions?.length || 0} questions?`)) return;

        category.subcategories = category.subcategories.filter(s => s.id !== subId);

        if (selectedSubcategory === subId) {
            selectedCategory = null;
            selectedSubcategory = null;
            document.getElementById('subcategoryHeader').style.display = 'none';
            document.getElementById('questionsList').innerHTML = '';
        }

        markAsChanged();
        populateCategories();
        updateGlobalStats();
        showStatus('✅ Subcategory deleted!', 'success');
    }

    // Edit subcategory button
    document.getElementById('editSubButton').addEventListener('click', () => {
        if (!selectedCategory || !selectedSubcategory) {
            showStatus('❌ No subcategory selected', 'error');
            return;
        }
        editSubcategory(selectedCategory, selectedSubcategory);
    });

    // Utility functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showStatus(message, type) {
        const existingStatus = document.querySelector('.status');
        if (existingStatus) {
            existingStatus.remove();
        }

        const status = document.createElement('div');
        status.className = `status ${type}`;
        status.textContent = message;
        status.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;

        if (type === 'success') {
            status.style.backgroundColor = '#10b981';
            status.style.color = 'white';
        } else if (type === 'error') {
            status.style.backgroundColor = '#ef4444';
            status.style.color = 'white';
        } else {
            status.style.backgroundColor = '#3b82f6';
            status.style.color = 'white';
        }

        document.body.appendChild(status);
        setTimeout(() => status.style.opacity = '1', 10);
        setTimeout(() => {
            status.style.opacity = '0';
            setTimeout(() => status.remove(), 300);
        }, 4000);
    }

    // Search, filter, and sort
    document.getElementById('searchInput').addEventListener('input', renderQuestions);
    document.getElementById('filterDifficulty').addEventListener('change', renderQuestions);
    document.getElementById('filterNew').addEventListener('change', renderQuestions);
    document.getElementById('sortBy').addEventListener('change', renderQuestions);

    // Add event listeners for buttons
    document.getElementById('addCategoryButton').addEventListener('click', openAddCategoryModal);

    document.getElementById('addSubcategoryButton').addEventListener('click', () => {
        if (!mainData || !mainData.categories || mainData.categories.length === 0) {
            showStatus('❌ No categories available. Create a category first.', 'error');
            return;
        }
        document.getElementById('addSubcategoryModal').classList.add('active');
        document.getElementById('parentCategorySelect').innerHTML = '<option value="">Select a category...</option>' +
            mainData.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
    });

    document.getElementById('reorganizeButton').addEventListener('click', () => {
        document.getElementById('reorganizeModal').classList.add('active');
        populateReorganizeCategories();
    });

    // Close modals on outside click or ESC key
    window.addEventListener('click', (event) => {
        const modals = ['importModal', 'aiPromptModal', 'categoryModal', 'addSubcategoryModal', 'reorganizeModal', 'subcategoryModal'];
        modals.forEach(id => {
            const modal = document.getElementById(id);
            if (modal && modal.classList.contains('active') && event.target === modal) {
                modal.classList.remove('active');
            }
        });
    });

    window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            const modals = ['importModal', 'aiPromptModal', 'categoryModal', 'addSubcategoryModal', 'reorganizeModal', 'subcategoryModal'];
            modals.forEach(id => {
                const modal = document.getElementById(id);
                if (modal && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                }
            });
        }
    });

    window.closeReorganizeModal = function() {
        document.getElementById('reorganizeModal').classList.remove('active');
    }

    // Enhanced Reorganize Categories with Drag & Drop
    function populateReorganizeCategories() {
        const list = document.getElementById('categoryList');
        list.innerHTML = '';

        if (!mainData || !mainData.categories) {
            list.innerHTML = '<p style="text-align: center; color: #6b7280;">No categories available</p>';
            return;
        }

        mainData.categories.forEach((cat, catIndex) => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'reorganize-category-item';
            categoryDiv.draggable = true;
            categoryDiv.dataset.categoryId = cat.id;
            categoryDiv.dataset.categoryIndex = catIndex;

            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'reorganize-category-header';
            categoryHeader.innerHTML = `
                <div class="reorganize-category-info">
                    <span class="category-drag-handle">⋮⋮</span>
                    <span class="expand-arrow">▶</span>
                    <span class="category-icon">${cat.icon || '📚'}</span>
                    <div class="category-name-wrapper">
                        <span class="category-main-name">${cat.name}</span>
                        <div class="category-badges">
                            <span class="level-badge">Lvl ${cat.requiredLevel || 1}</span>
                            <span class="category-stats-badge">${cat.subcategories?.length || 0} subcategories</span>
                        </div>
                    </div>
                </div>
                <div class="reorganize-category-actions">
                    <button class="btn-up" onclick="moveCategoryUp(${catIndex})" ${catIndex === 0 ? 'disabled' : ''}>↑</button>
                    <button class="btn-down" onclick="moveCategoryDown(${catIndex})" ${catIndex === mainData.categories.length - 1 ? 'disabled' : ''}>↓</button>
                    <button class="btn-edit" onclick="openEditCategoryModal('${cat.id}')">✏️ Edit</button>
                    <button class="btn-delete" onclick="deleteCategory('${cat.id}')">🗑️ Delete</button>
                </div>
            `;

            const subcategoriesDiv = document.createElement('div');
            subcategoriesDiv.className = 'reorganize-subcategories';

            if (cat.subcategories && cat.subcategories.length > 0) {
                cat.subcategories.forEach((sub, subIndex) => {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'reorganize-subcategory-item';
                    subDiv.draggable = true;
                    subDiv.dataset.categoryId = cat.id;
                    subDiv.dataset.subcategoryId = sub.id;
                    subDiv.dataset.subcategoryIndex = subIndex;
                    subDiv.innerHTML = `
                        <div class="reorganize-subcategory-info">
                            <span class="subcategory-drag-handle">⋮⋮</span>
                            <span class="subcategory-icon">${sub.icon || '📝'}</span>
                            <span class="subcategory-name">${sub.name}</span>
                            <span class="subcategory-count">${sub.questions?.length || 0}</span>
                        </div>
                        <div class="subcategory-actions">
                            <button class="btn-up" onclick="moveSubcategoryUp('${cat.id}', ${subIndex})" ${subIndex === 0 ? 'disabled' : ''}>↑</button>
                            <button class="btn-down" onclick="moveSubcategoryDown('${cat.id}', ${subIndex})" ${subIndex === cat.subcategories.length - 1 ? 'disabled' : ''}>↓</button>
                        </div>
                    `;

                    // Add subcategory drag event listeners
                    subDiv.addEventListener('dragstart', handleSubcategoryDragStart);
                    subDiv.addEventListener('dragover', handleSubcategoryDragOver);
                    subDiv.addEventListener('drop', handleSubcategoryDrop);
                    subDiv.addEventListener('dragend', handleSubcategoryDragEnd);

                    subcategoriesDiv.appendChild(subDiv);
                });
            } else {
                subcategoriesDiv.innerHTML = '<p style="padding: 10px; color: #9ca3af; font-size: 13px;">No subcategories</p>';
            }

            categoryHeader.onclick = (e) => {
                if (!e.target.closest('.reorganize-category-actions') && !e.target.closest('.category-drag-handle')) {
                    const arrow = categoryHeader.querySelector('.expand-arrow');
                    arrow.classList.toggle('expanded');
                    subcategoriesDiv.classList.toggle('expanded');
                }
            };

            // Add category drag event listeners
            categoryDiv.addEventListener('dragstart', handleCategoryDragStart);
            categoryDiv.addEventListener('dragover', handleCategoryDragOver);
            categoryDiv.addEventListener('drop', handleCategoryDrop);
            categoryDiv.addEventListener('dragend', handleCategoryDragEnd);

            categoryDiv.appendChild(categoryHeader);
            categoryDiv.appendChild(subcategoriesDiv);
            list.appendChild(categoryDiv);
        });
    }

    // Category drag and drop handlers
    let draggedCategory = null;
    let draggedSubcategory = null;

    function handleCategoryDragStart(e) {
        draggedCategory = {
            element: this,
            categoryId: this.dataset.categoryId,
            categoryIndex: parseInt(this.dataset.categoryIndex)
        };
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleCategoryDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        if (draggedCategory && this !== draggedCategory.element && this.classList.contains('reorganize-category-item')) {
            this.classList.add('drag-over');
        }
    }

    function handleCategoryDrop(e) {
        e.preventDefault();

        if (draggedCategory && this !== draggedCategory.element && this.classList.contains('reorganize-category-item')) {
            const targetIndex = parseInt(this.dataset.categoryIndex);
            const sourceIndex = draggedCategory.categoryIndex;

            // Move category in the data
            const [movedCategory] = mainData.categories.splice(sourceIndex, 1);
            mainData.categories.splice(targetIndex, 0, movedCategory);

            markAsChanged();
            populateReorganizeCategories();
            populateCategories();
            showStatus('✅ Category order updated!', 'success');
        }

        this.classList.remove('drag-over');
    }

    function handleCategoryDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.reorganize-category-item').forEach(el => {
            el.classList.remove('drag-over');
        });
        draggedCategory = null;
    }

    // Subcategory drag and drop handlers
    function handleSubcategoryDragStart(e) {
        e.stopPropagation();
        draggedSubcategory = {
            element: this,
            categoryId: this.dataset.categoryId,
            subcategoryId: this.dataset.subcategoryId,
            subcategoryIndex: parseInt(this.dataset.subcategoryIndex)
        };
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleSubcategoryDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'move';

        if (draggedSubcategory && this !== draggedSubcategory.element &&
            this.classList.contains('reorganize-subcategory-item') &&
            this.dataset.categoryId === draggedSubcategory.categoryId) {
            this.classList.add('drag-over');
        }
    }

    function handleSubcategoryDrop(e) {
        e.preventDefault();
        e.stopPropagation();

        if (draggedSubcategory && this !== draggedSubcategory.element &&
            this.classList.contains('reorganize-subcategory-item') &&
            this.dataset.categoryId === draggedSubcategory.categoryId) {

            const targetIndex = parseInt(this.dataset.subcategoryIndex);
            const sourceIndex = draggedSubcategory.subcategoryIndex;
            const categoryId = draggedSubcategory.categoryId;

            // Move subcategory in the data
            const category = mainData.categories.find(c => c.id === categoryId);
            const [movedSubcategory] = category.subcategories.splice(sourceIndex, 1);
            category.subcategories.splice(targetIndex, 0, movedSubcategory);

            markAsChanged();
            populateReorganizeCategories();
            populateCategories();
            showStatus('✅ Subcategory order updated!', 'success');
        }

        this.classList.remove('drag-over');
    }

    function handleSubcategoryDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.reorganize-subcategory-item').forEach(el => {
            el.classList.remove('drag-over');
        });
        draggedSubcategory = null;
    }

    // Up/Down button functions for categories
    window.moveCategoryUp = function(categoryIndex) {
        if (categoryIndex > 0) {
            const temp = mainData.categories[categoryIndex];
            mainData.categories[categoryIndex] = mainData.categories[categoryIndex - 1];
            mainData.categories[categoryIndex - 1] = temp;

            markAsChanged();
            populateReorganizeCategories();
            populateCategories();
            showStatus('✅ Category moved up!', 'success');
        }
    }

    window.moveCategoryDown = function(categoryIndex) {
        if (categoryIndex < mainData.categories.length - 1) {
            const temp = mainData.categories[categoryIndex];
            mainData.categories[categoryIndex] = mainData.categories[categoryIndex + 1];
            mainData.categories[categoryIndex + 1] = temp;

            markAsChanged();
            populateReorganizeCategories();
            populateCategories();
            showStatus('✅ Category moved down!', 'success');
        }
    }

    // Up/Down button functions for subcategories
    window.moveSubcategoryUp = function(categoryId, subcategoryIndex) {
        const category = mainData.categories.find(c => c.id === categoryId);
        if (subcategoryIndex > 0) {
            const temp = category.subcategories[subcategoryIndex];
            category.subcategories[subcategoryIndex] = category.subcategories[subcategoryIndex - 1];
            category.subcategories[subcategoryIndex - 1] = temp;

            markAsChanged();
            populateReorganizeCategories();
            populateCategories();
            showStatus('✅ Subcategory moved up!', 'success');
        }
    }

    window.moveSubcategoryDown = function(categoryId, subcategoryIndex) {
        const category = mainData.categories.find(c => c.id === categoryId);
        if (subcategoryIndex < category.subcategories.length - 1) {
            const temp = category.subcategories[subcategoryIndex];
            category.subcategories[subcategoryIndex] = category.subcategories[subcategoryIndex + 1];
            category.subcategories[subcategoryIndex + 1] = temp;

            markAsChanged();
            populateReorganizeCategories();
            populateCategories();
            showStatus('✅ Subcategory moved down!', 'success');
        }
    }

    window.openEditCategoryModal = function(catId) {
        const category = mainData.categories.find(c => c.id === catId);

        document.getElementById('catId').value = category.id;
        document.getElementById('catName').value = category.name;
        document.getElementById('catDesc').value = category.description;
        document.getElementById('catIcon').value = category.icon || '📚';
        document.getElementById('catColor').value = category.color || '#667eea';
        document.getElementById('catTimer').value = category.question_timer_seconds || 10;
        document.getElementById('catPoints').value = category.points_per_question || 10;
        document.getElementById('catRequiredLevel').value = category.requiredLevel || 1; // Fixed: correct field ID

        document.getElementById('categoryModalTitle').textContent = '✏️ Edit Category';
        editingCategoryId = catId;

        document.getElementById('reorganizeModal').classList.remove('active');
        document.getElementById('categoryModal').classList.add('active');
    }

    window.deleteCategory = function(catId) {
        const category = mainData.categories.find(c => c.id === catId);
        const totalQuestions = category.subcategories?.reduce((sum, sub) => sum + (sub.questions?.length || 0), 0) || 0;

        if (!confirm(`Delete category "${category.name}" with ${category.subcategories?.length || 0} subcategories and ${totalQuestions} total questions?`)) return;

        mainData.categories = mainData.categories.filter(c => c.id !== catId);

        if (selectedCategory === catId) {
            selectedCategory = null;
            selectedSubcategory = null;
            document.getElementById('subcategoryHeader').style.display = 'none';
            document.getElementById('questionsList').innerHTML = '';
        }

        markAsChanged();
        populateCategories();
        updateGlobalStats();
        populateReorganizeCategories();
        showStatus('✅ Category deleted!', 'success');
    }

    window.closeAddSubcategoryModal = function() {
        document.getElementById('addSubcategoryModal').classList.remove('active');
    }

    document.getElementById('saveNewSubcategoryButton').addEventListener('click', () => {
        const parentId = document.getElementById('parentCategorySelect').value;
        const id = document.getElementById('newSubId').value.trim();
        const name = document.getElementById('newSubName').value.trim();

        if (!parentId) {
            showStatus('❌ Select a parent category', 'error');
            return;
        }

        if (!id || !name) {
            showStatus('❌ ID and Name are required', 'error');
            return;
        }

        const category = mainData.categories.find(c => c.id === parentId);

        if (!category.subcategories) {
            category.subcategories = [];
        }

        if (category.subcategories.some(s => s.id === id)) {
            showStatus('❌ Subcategory ID already exists in this category', 'error');
            return;
        }

        const newSubcategory = {
            id,
            name,
            icon: document.getElementById('newSubIcon').value || '📝',
            color: document.getElementById('newSubColor').value || '#667eea',
            questions: []
        };

        category.subcategories.push(newSubcategory);

        markAsChanged();
        populateCategories();
        updateGlobalStats();
        closeAddSubcategoryModal();

        // Clear the form
        document.getElementById('newSubId').value = '';
        document.getElementById('newSubName').value = '';
        document.getElementById('newSubIcon').value = '📝';
        document.getElementById('newSubColor').value = '#667eea';

        showStatus('✅ Subcategory added!', 'success');
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl+S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            if (hasChanges) {
                document.getElementById('downloadButton').click();
            }
        }

        // Ctrl+F to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            const searchInput = document.getElementById('searchInput');
            if (searchInput && !document.querySelector('.modal.active')) {
                searchInput.focus();
                searchInput.select();
            }
        }
    });
</script>
</body>
</html>

