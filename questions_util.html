<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Manager Pro</title>
    <link rel="stylesheet" href="questions_util.css">
</head>
<body>
<div class="header">
    <h1>🎯 Quiz Manager Pro</h1>
    <div class="header-actions">
        <div class="stats-pill" id="totalQuestionsHeader">0 questions</div>
        <div id="unsavedBadge" class="unsaved-badge" style="display: none;">● Unsaved Changes</div>
        <button id="downloadButton" class="btn-success" style="display: none;">💾 Download JSON</button>
    </div>
</div>

<div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-section">
            <div class="file-input-wrapper">
                <button class="btn-load" onclick="document.getElementById('fileInput').click()">📁 Open questions.json</button>
                <input type="file" id="fileInput" accept=".json">
                <div id="filenameDisplay" class="filename-display"></div>
            </div>
        </div>

        <div class="sidebar-section">
            <h3>📂 Categories</h3>
            <button id="addCategoryButton" class="btn-add" style="display: none;" onclick="openAddCategoryModal()">+ Add Category</button>
            <button id="addSubcategoryButton" class="btn-add" style="display: none;">+ Add Subcategory</button>
            <button id="reorganizeButton" class="btn-secondary" style="display: none;">🔄 Reorganize</button>
            <ul id="categoryTree" class="category-tree"></ul>
        </div>

        <div class="sidebar-section" id="globalStats" style="display: none;">
            <h3>📊 Overview</h3>
            <div class="stats-summary">
                <div><span>Total Questions:</span> <strong id="globalTotal">0</strong></div>
                <div><span>Categories:</span> <strong id="globalCategories">0</strong></div>
                <div><span>Easy:</span> <strong id="globalEasy">0</strong></div>
                <div><span>Medium:</span> <strong id="globalMedium">0</strong></div>
                <div><span>Hard:</span> <strong id="globalHard">0</strong></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div id="welcomeScreen" class="welcome">
            <div class="welcome-icon">🚀</div>
            <h2>Welcome to Quiz Manager Pro</h2>
            <p style="margin-top: 10px; font-size: 15px;">Open your questions.json file to start</p>
            <p style="margin-top: 20px;">
                <button onclick="document.getElementById('fileInput').click()" class="btn-primary">Get Started</button>
            </p>
        </div>

        <div id="editorSection" style="display: none;">
            <!-- Subcategory Header -->
            <div class="subcategory-header" id="subcategoryHeader" style="display: none;">
                <h2 id="subcategoryTitle"></h2>
                <div class="subcategory-stats">
                    <div class="stat-card">
                        <div class="stat-card-value" id="subTotal">0</div>
                        <div class="stat-card-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="subEasy">0</div>
                        <div class="stat-card-label">Easy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="subMedium">0</div>
                        <div class="stat-card-label">Medium</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="subHard">0</div>
                        <div class="stat-card-label">Hard</div>
                    </div>
                </div>
                <div class="quick-actions">
                    <button id="exportSubButton" class="btn-info btn-sm">📤 Export</button>
                    <button id="editSubButton" class="btn-secondary btn-sm">✏️ Edit</button>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <input type="text" id="searchInput" placeholder="🔍 Search questions...">
                <select id="filterDifficulty">
                    <option value="">All Difficulties</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <select id="filterNew">
                    <option value="">All Questions</option>
                    <option value="new">New Only</option>
                </select>
                <button id="importJsonButton" class="btn-warning">📋 Import JSON</button>
                <button id="aiPromptButton" class="btn-primary">🤖 AI Prompt</button>
            </div>

            <!-- Questions Header with Sort -->
            <div class="questions-header">
                <div><strong id="questionCount">0 questions</strong></div>
                <div class="sort-controls">
                    <span>Sort by:</span>
                    <select id="sortBy">
                        <option value="default">Default Order</option>
                        <option value="id">ID (A-Z)</option>
                        <option value="difficulty">Difficulty</option>
                        <option value="newest">Newest First</option>
                    </select>
                </div>
            </div>

            <!-- Questions Grid -->
            <div id="questionsList" class="questions-grid"></div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>📋 Import Questions</h2>
            <span class="close" onclick="closeImportModal()">&times;</span>
        </div>

        <div class="form-group">
            <label>Paste JSON Array:</label>
            <textarea id="importTextarea" placeholder='[{"id":"q_001","question":"...","options":[...],"correct_answer":0,"explanation":"...","difficulty":"easy","points":10}]'></textarea>
            <div class="form-hint">Paste the JSON array from your AI assistant (ChatGPT, Claude, etc.)</div>
        </div>

        <div class="form-group">
            <label>Duplicate Handling:</label>
            <div class="duplicate-mode">
                <label><input type="radio" name="dupMode" value="skip" checked> 🚫 Skip</label>
                <label><input type="radio" name="dupMode" value="replace"> 🔄 Replace</label>
                <label><input type="radio" name="dupMode" value="rename"> ��️ Rename</label>
            </div>
        </div>

        <div id="importPreview" style="display: none;"></div>
        <div id="duplicatePreview" style="display: none;"></div>

        <div class="form-actions">
            <button onclick="closeImportModal()" class="btn-secondary">Cancel</button>
            <button id="validateImportButton" class="btn-primary">🔍 Validate</button>
            <button id="confirmImportButton" class="btn-success" style="display: none;">✅ Import</button>
        </div>
    </div>
</div>

<!-- AI Prompt Modal -->
<div id="aiPromptModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>🤖 AI Prompt Generator</h2>
            <span class="close" onclick="closeAiPromptModal()">&times;</span>
        </div>

        <div class="form-group">
            <label>Copy this prompt for ChatGPT/Claude:</label>
            <textarea id="aiPromptText" readonly style="font-size: 13px; min-height: 300px;"></textarea>
        </div>

        <div class="form-actions">
            <button onclick="closeAiPromptModal()" class="btn-secondary">Close</button>
            <button id="copyPromptButton" class="btn-success">📋 Copy to Clipboard</button>
        </div>
    </div>
</div>

<!-- Add/Edit Category Modal -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="categoryModalTitle">➕ Add New Category</h2>
            <span class="close" onclick="closeCategoryModal()">&times;</span>
        </div>

        <div id="categoryForm">
            <div class="form-group">
                <label>Category ID <span class="required">*</span></label>
                <input type="text" id="catId" placeholder="e.g., math_advanced" required>
                <div class="form-hint">Use lowercase with underscores (no spaces)</div>
            </div>
            <div class="form-group">
                <label>Category Name <span class="required">*</span></label>
                <input type="text" id="catName" placeholder="e.g., Advanced Mathematics" required>
            </div>
            <div class="form-group">
                <label>Description <span class="required">*</span></label>
                <input type="text" id="catDesc" placeholder="Short description" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Icon</label>
                    <input type="text" id="catIcon" placeholder="e.g., 🔢" maxlength="2" value="📚">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="catColor" value="#667eea">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Timer (seconds) <span class="required">*</span></label>
                    <input type="number" id="catTimer" value="10" min="5" max="60" required>
                </div>
                <div class="form-group">
                    <label>Points per Question <span class="required">*</span></label>
                    <input type="number" id="catPoints" value="10" min="1" max="100" required>
                </div>
            </div>
            <div class="form-group">
                <label>Required Level</label>
                <input type="number" id="catRequiredLevel" value="1" min="1" max="100">
                <div class="form-hint">Minimum player level required to access this category</div>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="closeCategoryModal()" class="btn-secondary">Cancel</button>
            <button id="saveCategoryButton" class="btn-success">✅ Save Category</button>
        </div>
    </div>
</div>

<!-- Add Subcategory Modal -->
<div id="addSubcategoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>�� Add Subcategory</h2>
            <span class="close" onclick="closeAddSubcategoryModal()">&times;</span>
        </div>

        <div id="addSubcategoryForm">
            <div class="form-group">
                <label>Parent Category <span class="required">*</span></label>
                <select id="parentCategorySelect" required>
                    <option value="">Select a category...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Subcategory ID <span class="required">*</span></label>
                <input type="text" id="newSubId" placeholder="e.g., calculus_basics" required>
                <div class="form-hint">Use lowercase with underscores (no spaces)</div>
            </div>
            <div class="form-group">
                <label>Subcategory Name <span class="required">*</span></label>
                <input type="text" id="newSubName" placeholder="e.g., Calculus Basics" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Icon</label>
                    <input type="text" id="newSubIcon" placeholder="e.g., 📐" maxlength="2" value="📝">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="newSubColor" value="#667eea">
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="closeAddSubcategoryModal()" class="btn-secondary">Cancel</button>
            <button id="saveNewSubcategoryButton" class="btn-success">✅ Add Subcategory</button>
        </div>
    </div>
</div>

<!-- Reorganize Modal -->
<div id="reorganizeModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2>🔄 Reorganize Categories</h2>
            <span class="close" onclick="closeReorganizeModal()">&times;</span>
        </div>

        <div class="reorganize-section">
            <h3>Category Management</h3>
            <div class="category-management">
                <div id="categoryList" class="category-list"></div>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="closeReorganizeModal()" class="btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Edit Subcategory Modal -->
<div id="subcategoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="subcategoryModalTitle">✏️ Edit Subcategory</h2>
            <span class="close" onclick="closeSubcategoryModal()">&times;</span>
        </div>

        <div id="subcategoryForm">
            <div class="form-group">
                <label>Subcategory ID <span class="required">*</span></label>
                <input type="text" id="subId" placeholder="e.g., calculus_basics" required>
                <div class="form-hint">Use lowercase with underscores (no spaces)</div>
            </div>
            <div class="form-group">
                <label>Subcategory Name <span class="required">*</span></label>
                <input type="text" id="subName" placeholder="e.g., Calculus Basics" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Icon</label>
                    <input type="text" id="subIcon" placeholder="e.g., 📐" maxlength="2" value="📝">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <input type="color" id="subColor" value="#667eea">
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="closeSubcategoryModal()" class="btn-secondary">Cancel</button>
            <button id="saveSubcategoryButton" class="btn-success">✅ Save Changes</button>
        </div>
    </div>
</div>

<script>
    let mainData = null;
    let originalFilename = 'questions.json';
    let selectedCategory = null;
    let selectedSubcategory = null;
    let newQuestions = new Set();
    let hasChanges = false;
    let editingCategoryId = null;
    let editingSubcategoryId = null;

    // File input handler
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        originalFilename = file.name;
        const reader = new FileReader();

        reader.onload = (event) => {
            try {
                mainData = JSON.parse(event.target.result);

                if (!mainData.categories || !Array.isArray(mainData.categories)) {
                    throw new Error('Invalid JSON structure');
                }

                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('editorSection').style.display = 'block';
                document.getElementById('filenameDisplay').textContent = `Loaded: ${file.name}`;
                document.getElementById('addCategoryButton').style.display = 'block';
                document.getElementById('addSubcategoryButton').style.display = 'block';
                document.getElementById('reorganizeButton').style.display = 'block';
                document.getElementById('globalStats').style.display = 'block';

                populateCategories();
                updateGlobalStats();
                showStatus('✅ File loaded successfully!', 'success');
            } catch (err) {
                showStatus('❌ Error: ' + err.message, 'error');
            }
        };

        reader.readAsText(file);
    });

    function populateCategories() {
        const tree = document.getElementById('categoryTree');
        tree.innerHTML = '';

        mainData.categories.forEach(cat => {
            cat.subcategories?.forEach(sub => {
                const li = document.createElement('li');
                li.className = 'category-item';
                li.innerHTML = `
                    <span>${cat.name} › ${sub.name}</span>
                    <div class="category-actions">
                        <button onclick="editSubcategory('${cat.id}', '${sub.id}')">✏️</button>
                        <button onclick="deleteSubcategory('${cat.id}', '${sub.id}')">🗑️</button>
                    </div>
                    <span class="category-count">${sub.questions?.length || 0}</span>
                `;
                li.onclick = (e) => {
                    if (!e.target.closest('.category-actions')) {
                        selectSubcategory(cat.id, sub.id, li);
                    }
                };
                tree.appendChild(li);
            });
        });
    }

    function selectSubcategory(catId, subId, element) {
        document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        selectedCategory = catId;
        selectedSubcategory = subId;

        const category = mainData.categories.find(c => c.id === catId);
        const subcategory = category.subcategories.find(s => s.id === subId);

        document.getElementById('subcategoryHeader').style.display = 'block';
        document.getElementById('subcategoryTitle').textContent = `${category.name} › ${subcategory.name}`;

        updateSubcategoryStats();
        renderQuestions();
    }

    function updateSubcategoryStats() {
        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
        const questions = subcategory.questions || [];

        document.getElementById('subTotal').textContent = questions.length;
        document.getElementById('subEasy').textContent = questions.filter(q => q.difficulty === 'easy').length;
        document.getElementById('subMedium').textContent = questions.filter(q => q.difficulty === 'medium').length;
        document.getElementById('subHard').textContent = questions.filter(q => q.difficulty === 'hard').length;
    }

    function updateGlobalStats() {
        let total = 0, easy = 0, medium = 0, hard = 0;

        mainData.categories.forEach(cat => {
            cat.subcategories?.forEach(sub => {
                const questions = sub.questions || [];
                total += questions.length;
                easy += questions.filter(q => q.difficulty === 'easy').length;
                medium += questions.filter(q => q.difficulty === 'medium').length;
                hard += questions.filter(q => q.difficulty === 'hard').length;
            });
        });

        document.getElementById('globalTotal').textContent = total;
        document.getElementById('globalCategories').textContent = mainData.categories.length;
        document.getElementById('globalEasy').textContent = easy;
        document.getElementById('globalMedium').textContent = medium;
        document.getElementById('globalHard').textContent = hard;
        document.getElementById('totalQuestionsHeader').textContent = `${total} questions`;
    }

    function renderQuestions() {
        const list = document.getElementById('questionsList');
        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);

        if (!subcategory.questions) subcategory.questions = [];

        let questions = [...subcategory.questions];
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const diffFilter = document.getElementById('filterDifficulty').value;
        const newFilter = document.getElementById('filterNew').value;
        const sortBy = document.getElementById('sortBy').value;

        // Apply filters
        if (searchTerm) {
            questions = questions.filter(q =>
                q.question.toLowerCase().includes(searchTerm) || q.id.toLowerCase().includes(searchTerm)
            );
        }

        if (diffFilter) {
            questions = questions.filter(q => q.difficulty === diffFilter);
        }

        if (newFilter === 'new') {
            questions = questions.filter(q => newQuestions.has(q.id));
        }

        // Apply sorting
        if (sortBy === 'id') {
            questions.sort((a, b) => a.id.localeCompare(b.id));
        } else if (sortBy === 'difficulty') {
            const diffOrder = { easy: 1, medium: 2, hard: 3 };
            questions.sort((a, b) => diffOrder[a.difficulty] - diffOrder[b.difficulty]);
        } else if (sortBy === 'newest') {
            questions = questions.filter(q => newQuestions.has(q.id)).concat(
                questions.filter(q => !newQuestions.has(q.id))
            );
        }

        document.getElementById('questionCount').textContent = `${questions.length} question${questions.length !== 1 ? 's' : ''}`;

        if (questions.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-icon">📭</div><p>No questions found. Click "Import JSON" to add.</p></div>';
            return;
        }

        list.innerHTML = questions.map(q => `
            <div class="question-card ${newQuestions.has(q.id) ? 'new' : ''}">
                <div class="question-header">
                    <div class="question-title">
                        ${escapeHtml(q.question)}
                        ${newQuestions.has(q.id) ? '<span class="badge badge-new">NEW</span>' : ''}
                    </div>
                    <div class="question-actions">
                        <button class="btn-danger btn-sm" onclick="deleteQuestion('${escapeHtml(q.id)}')">🗑️</button>
                    </div>
                </div>
                <div class="question-options">
                    ${q.options.map((opt, idx) => `
                        <div class="option ${idx === q.correct_answer ? 'correct' : ''}">${escapeHtml(opt)}</div>
                    `).join('')}
                </div>
                <div style="margin: 12px 0; font-size: 13px; color: #666;">
                    <strong>Explanation:</strong> ${escapeHtml(q.explanation)}
                </div>
                <div class="question-meta">
                    <span class="question-id">
                        <strong>ID:</strong> ${q.id}
                        <button class="copy-id-btn" onclick="copyToClipboard('${q.id}', event)">📋</button>
                    </span>
                    <span class="badge badge-${q.difficulty}">${q.difficulty.toUpperCase()}</span>
                    <span><strong>Points:</strong> ${q.points}</span>
                </div>
            </div>
        `).join('');
    }

    window.copyToClipboard = function(text, event) {
        event.stopPropagation();
        navigator.clipboard.writeText(text).then(() => {
            showStatus(`✅ Copied: ${text}`, 'success');
        });
    }

    window.deleteQuestion = function(id) {
        if (!confirm('Delete this question?')) return;

        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
        subcategory.questions = subcategory.questions.filter(q => q.id !== id);
        newQuestions.delete(id);

        markAsChanged();
        renderQuestions();
        updateSubcategoryStats();
        populateCategories();
        updateGlobalStats();
        showStatus('✅ Question deleted', 'success');
    }

    function markAsChanged() {
        hasChanges = true;
        document.getElementById('unsavedBadge').style.display = 'block';
        document.getElementById('downloadButton').style.display = 'block';
    }

    // Download button
    document.getElementById('downloadButton').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(mainData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = originalFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showStatus('�� File downloaded! Replace your old file.', 'success');
    });

    // Export subcategory
    document.getElementById('exportSubButton').addEventListener('click', () => {
        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);

        const blob = new Blob([JSON.stringify(subcategory.questions || [], null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${selectedSubcategory}_questions.json`;
        a.click();
        URL.revokeObjectURL(url);
        showStatus('✅ Subcategory exported!', 'success');
    });

    // Import Modal
    document.getElementById('importJsonButton').addEventListener('click', () => {
        if (!selectedCategory || !selectedSubcategory) {
            showStatus('❌ Select a subcategory first', 'error');
            return;
        }
        document.getElementById('importModal').classList.add('active');
        document.getElementById('importTextarea').value = '';
        document.getElementById('importPreview').style.display = 'none';
        document.getElementById('duplicatePreview').style.display = 'none';
        document.getElementById('confirmImportButton').style.display = 'none';
    });

    function closeImportModal() {
        document.getElementById('importModal').classList.remove('active');
    }

    document.getElementById('validateImportButton').addEventListener('click', () => {
        try {
            const questions = JSON.parse(document.getElementById('importTextarea').value);

            if (!Array.isArray(questions)) throw new Error('Must be an array');
            if (questions.length === 0) throw new Error('Array is empty');

            // Validate each question
            const errors = [];
            questions.forEach((q, idx) => {
                if (!q.id) errors.push(`Q${idx + 1}: Missing ID`);
                if (!q.question) errors.push(`Q${idx + 1}: Missing question`);
                if (!Array.isArray(q.options) || q.options.length < 2) errors.push(`Q${idx + 1}: Need 2+ options`);
                if (typeof q.correct_answer !== 'number' || q.correct_answer < 0 || q.correct_answer >= q.options?.length) errors.push(`Q${idx + 1}: Invalid correct_answer`);
                if (!q.explanation) errors.push(`Q${idx + 1}: Missing explanation`);
                if (!['easy', 'medium', 'hard'].includes(q.difficulty)) errors.push(`Q${idx + 1}: Invalid difficulty (must be easy/medium/hard)`);
                if (typeof q.points !== 'number' || q.points <= 0) errors.push(`Q${idx + 1}: Invalid points`);
            });

            if (errors.length > 0) {
                throw new Error(errors.join('; '));
            }

            const category = mainData.categories.find(c => c.id === selectedCategory);
            const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
            const existingIds = new Set(subcategory.questions.map(q => q.id));
            const mode = document.querySelector('input[name="dupMode"]:checked').value;

            const duplicates = questions.filter(q => existingIds.has(q.id));
            const validQuestions = [];

            questions.forEach(q => {
                if (existingIds.has(q.id)) {
                    if (mode === 'replace') {
                        validQuestions.push(q);
                    } else if (mode === 'rename') {
                        let newId = q.id;
                        let v = 2;
                        while (existingIds.has(newId)) {
                            newId = `${q.id}_v${v++}`;
                        }
                        q.id = newId;
                        existingIds.add(newId);
                        validQuestions.push(q);
                    }
                } else {
                    validQuestions.push(q);
                    existingIds.add(q.id);
                }
            });

            // Show duplicate details
            if (duplicates.length > 0) {
                document.getElementById('duplicatePreview').innerHTML = `
                    <div class="duplicate-preview">
                        <h4>⚠️ ${duplicates.length} Duplicate ID(s) Found</h4>
                        <div class="duplicate-list">
                            ${duplicates.map(d => `<div class="duplicate-item">
                                <strong>${d.id}</strong>: ${escapeHtml(d.question.substring(0, 80))}...
                            </div>`).join('')}
                        </div>
                        <p style="margin-top: 10px; font-size: 13px;">
                            <strong>Action:</strong> ${mode === 'skip' ? 'These will be SKIPPED' : mode === 'replace' ? 'These will REPLACE existing' : 'These will be RENAMED (_v2, _v3, etc.)'}
                        </p>
                    </div>
                `;
                document.getElementById('duplicatePreview').style.display = 'block';
            } else {
                document.getElementById('duplicatePreview').style.display = 'none';
            }

            const easyCount = validQuestions.filter(q => q.difficulty === 'easy').length;
            const mediumCount = validQuestions.filter(q => q.difficulty === 'medium').length;
            const hardCount = validQuestions.filter(q => q.difficulty === 'hard').length;

            document.getElementById('importPreview').innerHTML = `
                <div class="changes-preview">
                    <h4>✅ Validation Successful</h4>
                    <p style="font-size: 14px; margin-bottom: 10px;">
                        <strong>${validQuestions.length} questions</strong> will be imported
                    </p>
                    <div class="import-details">
                        <div class="import-detail">
                            <div class="import-detail-value">${easyCount}</div>
                            <div class="import-detail-label">Easy</div>
                        </div>
                        <div class="import-detail">
                            <div class="import-detail-value">${mediumCount}</div>
                            <div class="import-detail-label">Medium</div>
                        </div>
                        <div class="import-detail">
                            <div class="import-detail-value">${hardCount}</div>
                            <div class="import-detail-label">Hard</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('importPreview').style.display = 'block';
            document.getElementById('confirmImportButton').style.display = 'block';

            window.validatedQuestions = { questions: validQuestions, mode };

        } catch (err) {
            showStatus('❌ ' + err.message, 'error');
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('duplicatePreview').style.display = 'none';
            document.getElementById('confirmImportButton').style.display = 'none';
        }
    });

    document.getElementById('confirmImportButton').addEventListener('click', () => {
        const category = mainData.categories.find(c => c.id === selectedCategory);
        const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
        const { questions, mode } = window.validatedQuestions;

        if (mode === 'replace') {
            const ids = new Set(questions.map(q => q.id));
            subcategory.questions = subcategory.questions.filter(q => !ids.has(q.id));
        }

        questions.forEach(q => newQuestions.add(q.id));
        subcategory.questions.push(...questions);

        markAsChanged();
        renderQuestions();
        updateSubcategoryStats();
        populateCategories();
        updateGlobalStats();
        closeImportModal();
        showStatus(`✅ Imported ${questions.length} questions!`, 'success');
    });

    // AI Prompt - UPDATED TO 20 QUESTIONS
// AI Prompt - FIXED VERSION
document.getElementById('aiPromptButton').addEventListener('click', () => {
    if (!selectedCategory || !selectedSubcategory) {
        showStatus('❌ Select a subcategory first', 'error');
        return;
    }

    const category = mainData.categories.find(c => c.id === selectedCategory);
    const subcategory = category.subcategories.find(s => s.id === selectedSubcategory);
    const nextNum = (subcategory.questions?.length || 0) + 1;
    const prefix = selectedSubcategory.split('_').pop();

    const prompt = `Generate 20 high-quality quiz questions for "${category.name} > ${subcategory.name}".

CRITICAL: Return ONLY a valid JSON array. No markdown code blocks, no explanations, no extra text.

[
  {
    "id": "${prefix}_${String(nextNum).padStart(3,'0')}",
    "question": "Your well-crafted question here?",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "correct_answer": 0,
    "explanation": "Clear, educational explanation of why this answer is correct.",
    "difficulty": "easy",
    "points": 10
  }
]

Requirements:
- Exactly 20 questions
- Difficulty mix: 8 easy, 8 medium, 4 hard
- All questions worth 10 points
- correct_answer is index (0-3)
- All 4 options should be plausible
- Explanations should be educational and clear
- Increment IDs: ${prefix}_${String(nextNum).padStart(3,'0')}, ${prefix}_${String(nextNum+1).padStart(3,'0')}, etc.

IMPORTANT: Return ONLY the JSON array. No code block markers, no text before or after.`;

    document.getElementById('aiPromptText').value = prompt;
    document.getElementById('aiPromptModal').classList.add('active');
});

    function closeAiPromptModal() {
        document.getElementById('aiPromptModal').classList.remove('active');
    }

    document.getElementById('copyPromptButton').addEventListener('click', () => {
        const text = document.getElementById('aiPromptText').value;
        navigator.clipboard.writeText(text).then(() => {
            showStatus('✅ Prompt copied! Paste into ChatGPT/Claude', 'success');
        });
    });

    // Category Management
    function openAddCategoryModal() {
        document.getElementById('categoryModal').classList.add('active');
        document.getElementById('categoryModalTitle').textContent = '➕ Add New Category';
        editingCategoryId = null;

        // Clear form
        document.getElementById('catId').value = '';
        document.getElementById('catName').value = '';
        document.getElementById('catDesc').value = '';
        document.getElementById('catIcon').value = '📚';
        document.getElementById('catColor').value = '#667eea';
        document.getElementById('catTimer').value = '10';
        document.getElementById('catPoints').value = '10';
        document.getElementById('catRequiredLevel').value = '1';
    }

    function closeCategoryModal() {
        document.getElementById('categoryModal').classList.remove('active');
    }

    document.getElementById('saveCategoryButton').addEventListener('click', () => {
        const id = document.getElementById('catId').value.trim();
        const name = document.getElementById('catName').value.trim();
        const desc = document.getElementById('catDesc').value.trim();
        const timer = parseInt(document.getElementById('catTimer').value);
        const points = parseInt(document.getElementById('catPoints').value);
        const requiredLevel = parseInt(document.getElementById('catRequiredLevel').value);

        if (!id || !name || !desc) {
            showStatus('❌ ID, Name, and Description are required', 'error');
            return;
        }

        if (!editingCategoryId && mainData.categories.some(c => c.id === id)) {
            showStatus('❌ Category ID already exists', 'error');
            return;
        }

        if (editingCategoryId) {
            const cat = mainData.categories.find(c => c.id === editingCategoryId);
            cat.name = name;
            cat.description = desc;
            cat.icon = document.getElementById('catIcon').value;
            cat.color = document.getElementById('catColor').value;
            cat.question_timer_seconds = timer;
            cat.points_per_question = points;
            cat.required_level = requiredLevel;
            showStatus('✅ Category updated!', 'success');
        } else {
            mainData.categories.push({
                id,
                name,
                description: desc,
                icon: document.getElementById('catIcon').value,
                color: document.getElementById('catColor').value,
                question_timer_seconds: timer,
                points_per_question: points,
                required_level: requiredLevel,
                subcategories: []
            });
            showStatus('✅ Category created!', 'success');
        }

        markAsChanged();
        populateCategories();
        updateGlobalStats();
        closeCategoryModal();
    });

    // Subcategory Management
    function closeSubcategoryModal() {
        document.getElementById('subcategoryModal').classList.remove('active');
    }

    window.editSubcategory = function(catId, subId) {
        const category = mainData.categories.find(c => c.id === catId);
        const subcategory = category.subcategories.find(s => s.id === subId);

        editingCategoryId = catId;
        editingSubcategoryId = subId;

        document.getElementById('subcategoryModal').classList.add('active');
        document.getElementById('subcategoryModalTitle').textContent = '✏️ Edit Subcategory';

        document.getElementById('subId').value = subcategory.id;
        document.getElementById('subName').value = subcategory.name;
        document.getElementById('subIcon').value = subcategory.icon || '📝';
        document.getElementById('subColor').value = subcategory.color || '#667eea';
    }

    document.getElementById('saveSubcategoryButton').addEventListener('click', () => {
        const id = document.getElementById('subId').value.trim();
        const name = document.getElementById('subName').value.trim();

        if (!id || !name) {
            showStatus('❌ ID and Name are required', 'error');
            return;
        }

        const category = mainData.categories.find(c => c.id === editingCategoryId);
        const subcategory = category.subcategories.find(s => s.id === editingSubcategoryId);

        subcategory.id = id;
        subcategory.name = name;
        subcategory.icon = document.getElementById('subIcon').value;
        subcategory.color = document.getElementById('subColor').value;

        if (selectedSubcategory === editingSubcategoryId) {
            selectedSubcategory = id;
            document.getElementById('subcategoryTitle').textContent = `${category.name} › ${name}`;
        }

        markAsChanged();
        populateCategories();
        closeSubcategoryModal();
        showStatus('✅ Subcategory updated!', 'success');
    });

    window.deleteSubcategory = function(catId, subId) {
        const category = mainData.categories.find(c => c.id === catId);
        const subcategory = category.subcategories.find(s => s.id === subId);

        if (!confirm(`Delete "${subcategory.name}" with ${subcategory.questions?.length || 0} questions?`)) return;

        category.subcategories = category.subcategories.filter(s => s.id !== subId);

        if (selectedSubcategory === subId) {
            selectedCategory = null;
            selectedSubcategory = null;
            document.getElementById('subcategoryHeader').style.display = 'none';
            document.getElementById('questionsList').innerHTML = '';
        }

        markAsChanged();
        populateCategories();
        updateGlobalStats();
        showStatus('✅ Subcategory deleted!', 'success');
    }

    // Edit subcategory button
    document.getElementById('editSubButton').addEventListener('click', () => {
        editSubcategory(selectedCategory, selectedSubcategory);
    });

    // Utility functions - FIXED: Added missing functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showStatus(message, type) {
        const status = document.createElement('div');
        status.className = `status ${type}`;
        status.textContent = message;
        status.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;

        if (type === 'success') {
            status.style.backgroundColor = '#10b981';
            status.style.color = 'white';
        } else if (type === 'error') {
            status.style.backgroundColor = '#ef4444';
            status.style.color = 'white';
        } else {
            status.style.backgroundColor = '#3b82f6';
            status.style.color = 'white';
        }

        document.body.appendChild(status);
        setTimeout(() => status.style.opacity = '1', 10);
        setTimeout(() => {
            status.style.opacity = '0';
            setTimeout(() => status.remove(), 300);
        }, 4000);
    }

    // Search, filter, and sort
    document.getElementById('searchInput').addEventListener('input', renderQuestions);
    document.getElementById('filterDifficulty').addEventListener('change', renderQuestions);
    document.getElementById('filterNew').addEventListener('change', renderQuestions);
    document.getElementById('sortBy').addEventListener('change', renderQuestions);

    // Add event listeners for the buttons that weren't working
    document.getElementById('addCategoryButton').addEventListener('click', openAddCategoryModal);

    document.getElementById('addSubcategoryButton').addEventListener('click', () => {
        if (!mainData || !mainData.categories || mainData.categories.length === 0) {
            showStatus('❌ No categories available. Create a category first.', 'error');
            return;
        }
        document.getElementById('addSubcategoryModal').classList.add('active');
        document.getElementById('parentCategorySelect').innerHTML = '<option value="">Select a category...</option>' +
            mainData.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
    });

    document.getElementById('reorganizeButton').addEventListener('click', () => {
        document.getElementById('reorganizeModal').classList.add('active');
        populateReorganizeCategories();
    });

    // Close modals on outside click
    window.addEventListener('click', (event) => {
        const modals = ['importModal', 'aiPromptModal', 'categoryModal', 'addSubcategoryModal', 'reorganizeModal', 'subcategoryModal'];
        modals.forEach(id => {
            const modal = document.getElementById(id);
            if (modal && modal.classList.contains('active') && event.target === modal) {
                modal.classList.remove('active');
            }
        });
    });

    function closeReorganizeModal() {
        document.getElementById('reorganizeModal').classList.remove('active');
    }

    function populateReorganizeCategories() {
        const list = document.getElementById('categoryList');
        list.innerHTML = '';

        if (!mainData || !mainData.categories) {
            list.innerHTML = '<p>No categories available</p>';
            return;
        }

        mainData.categories.forEach(cat => {
            const item = document.createElement('div');
            item.className = 'category-item';
            item.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                margin-bottom: 10px;
                background: white;
            `;
            item.innerHTML = `
                <div class="category-info">
                    <span class="category-name" style="font-weight: 600; font-size: 16px;">${cat.name}</span>
                    <span class="category-count" style="color: #6b7280; margin-left: 10px;">${cat.subcategories?.length || 0} subcategories</span>
                </div>
                <div class="category-actions">
                    <button class="btn-secondary" onclick="openEditCategoryModal('${cat.id}')" style="margin-right: 8px; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; background: white;">✏️ Edit</button>
                    <button class="btn-danger" onclick="deleteCategory('${cat.id}')" style="padding: 6px 12px; border: none; border-radius: 4px; background: #ef4444; color: white;">🗑️ Delete</button>
                </div>
            `;
            list.appendChild(item);
        });
    }

    window.openEditCategoryModal = function(catId) {
        const category = mainData.categories.find(c => c.id === catId);

        document.getElementById('catId').value = category.id;
        document.getElementById('catName').value = category.name;
        document.getElementById('catDesc').value = category.description;
        document.getElementById('catIcon').value = category.icon || '📚';
        document.getElementById('catColor').value = category.color || '#667eea';
        document.getElementById('catTimer').value = category.question_timer_seconds || 10;
        document.getElementById('catPoints').value = category.points_per_question || 10;
        document.getElementById('catRequiredLevel').value = category.required_level || 1;

        document.getElementById('categoryModalTitle').textContent = '✏️ Edit Category';
        editingCategoryId = catId;

        document.getElementById('reorganizeModal').classList.remove('active');
        document.getElementById('categoryModal').classList.add('active');
    }

    window.deleteCategory = function(catId) {
        if (!confirm('Delete this category and all its subcategories?')) return;

        mainData.categories = mainData.categories.filter(c => c.id !== catId);

        if (selectedCategory === catId) {
            selectedCategory = null;
            selectedSubcategory = null;
            document.getElementById('subcategoryHeader').style.display = 'none';
            document.getElementById('questionsList').innerHTML = '';
        }

        markAsChanged();
        populateCategories();
        updateGlobalStats();
        populateReorganizeCategories();
        showStatus('✅ Category deleted!', 'success');
    }

    function closeAddSubcategoryModal() {
        document.getElementById('addSubcategoryModal').classList.remove('active');
    }

    document.getElementById('saveNewSubcategoryButton').addEventListener('click', () => {
        const parentId = document.getElementById('parentCategorySelect').value;
        const id = document.getElementById('newSubId').value.trim();
        const name = document.getElementById('newSubName').value.trim();

        if (!parentId) {
            showStatus('❌ Select a parent category', 'error');
            return;
        }

        if (!id || !name) {
            showStatus('❌ ID and Name are required', 'error');
            return;
        }

        const category = mainData.categories.find(c => c.id === parentId);

        if (!category.subcategories) {
            category.subcategories = [];
        }

        if (category.subcategories.some(s => s.id === id)) {
            showStatus('❌ Subcategory ID already exists in this category', 'error');
            return;
        }

        const newSubcategory = {
            id,
            name,
            icon: document.getElementById('newSubIcon').value || '📝',
            color: document.getElementById('newSubColor').value || '#667eea',
            questions: []
        };

        category.subcategories.push(newSubcategory);

        markAsChanged();
        populateCategories();
        updateGlobalStats();
        closeAddSubcategoryModal();

        // Clear the form
        document.getElementById('newSubId').value = '';
        document.getElementById('newSubName').value = '';
        document.getElementById('newSubIcon').value = '📝';
        document.getElementById('newSubColor').value = '#667eea';

        showStatus('✅ Subcategory added!', 'success');
    });
</script>
</body>
</html>
